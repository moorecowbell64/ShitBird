; ShitBird Firmware - PlatformIO Configuration
; Target: LilyGo T-Deck Plus (ESP32-S3)
; https://github.com/Xinyuan-LilyGO/T-Deck

[platformio]
default_envs = tdeck-plus
src_dir = src
data_dir = data

[env]
platform = espressif32@6.4.0
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions.csv

lib_deps =
    ; Display
    bodmer/TFT_eSPI@^2.5.43
    lvgl/lvgl@^8.3.11

    ; LoRa Radio
    jgromes/RadioLib@^6.4.0

    ; WiFi & Networking
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    bblanchon/ArduinoJson@^7.0.0

    ; BLE
    h2zero/NimBLE-Arduino@^1.4.1

    ; IR
    crankyoldgit/IRremoteESP8266@^2.8.6

    ; GPS
    mikalhart/TinyGPSPlus@^1.0.3

    ; SD Card
    ; (built-in SD library)

    ; Audio
    earlephilhower/ESP8266Audio@^1.9.7

    ; Crypto
    rweather/Crypto@^0.4.0

build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

    ; LVGL Configuration
    -DLV_CONF_INCLUDE_SIMPLE
    -DLV_CONF_PATH="${platformio.include_dir}/lv_conf.h"

    ; TFT_eSPI Configuration (inline for T-Deck Plus)
    -DUSER_SETUP_LOADED=1
    -DST7789_DRIVER=1
    -DINIT_SEQUENCE_3=1
    -DCGRAM_OFFSET=1
    -DTFT_RGB_ORDER=TFT_RGB
    -DTFT_INVERSION_ON=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    -DTFT_MOSI=41
    -DTFT_MISO=38
    -DTFT_SCLK=40
    -DTFT_CS=12
    -DTFT_DC=11
    -DTFT_RST=-1
    -DTFT_BL=42
    -DTOUCH_CS=-1
    -DUSE_HSPI_PORT=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=16000000
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1

    ; ShitBird Build Info
    -DSHITBIRD_VERSION=\"1.0.0\"
    -DSHITBIRD_BUILD_DATE=\"${UNIX_TIME}\"

[env:tdeck-plus]
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.arduino.memory_type = qio_opi
board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216

build_flags =
    ${env.build_flags}
    -DBOARD_TDECK_PLUS=1

; Extra scripts for build automation
extra_scripts =
    pre:tools/build_version.py
    post:tools/merge_firmware.py

[env:tdeck-plus-debug]
extends = env:tdeck-plus
build_type = debug
build_flags =
    ${env:tdeck-plus.build_flags}
    -DCORE_DEBUG_LEVEL=4
    -DDEBUG_MODE=1

monitor_filters = esp32_exception_decoder
