<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShitBird Web Flasher</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text: #00ff00;
            --text-dim: #00aa00;
            --accent: #00ffff;
            --warning: #ffaa00;
            --error: #ff0000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-dim);
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--text-dim);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card h2 {
            color: var(--accent);
            font-size: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--text-dim);
            padding-bottom: 0.5rem;
        }

        .btn {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--text);
            padding: 0.75rem 1.5rem;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin: 0.5rem 0;
        }

        .btn:hover:not(:disabled) {
            background: var(--text);
            color: var(--bg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn.primary:hover:not(:disabled) {
            background: var(--accent);
            color: var(--bg);
        }

        .btn.warning {
            border-color: var(--warning);
            color: var(--warning);
        }

        .btn.warning:hover:not(:disabled) {
            background: var(--warning);
            color: var(--bg);
        }

        .progress-container {
            margin: 1rem 0;
        }

        .progress-bar {
            background: var(--bg);
            border: 1px solid var(--text-dim);
            height: 30px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--text);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg);
            font-weight: bold;
        }

        .status {
            text-align: center;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .status.info {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .status.success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid var(--text);
        }

        .status.error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .status.warning {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .log {
            background: var(--bg);
            border: 1px solid var(--text-dim);
            padding: 0.5rem;
            height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .hidden {
            display: none;
        }

        .file-info {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        .instructions {
            color: var(--text-dim);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .instructions ol {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .instructions li {
            margin: 0.5rem 0;
        }

        .warning-box {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .logo {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üê¶</div>
            <h1>ShitBird Web Flasher</h1>
            <p>Flash firmware directly from your browser</p>
        </div>

        <div class="card">
            <h2>> Browser Compatibility</h2>
            <div id="browser-check">
                <p>Checking browser compatibility...</p>
            </div>
        </div>

        <div class="card">
            <h2>> Instructions</h2>
            <div class="instructions">
                <ol>
                    <li>Connect your T-Deck Plus to your computer via USB</li>
                    <li>Put device in download mode:
                        <br>‚Ä¢ Hold the trackball button
                        <br>‚Ä¢ While holding, insert USB cable
                        <br>‚Ä¢ Release button after connecting
                    </li>
                    <li>Click "Connect Device" and select the COM/serial port</li>
                    <li>Select the firmware file (.bin)</li>
                    <li>Click "Flash Firmware" to begin</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <h2>> Device Connection</h2>
            <button class="btn primary" id="connect-btn" onclick="connectDevice()">
                Connect Device
            </button>
            <div id="device-status" class="status hidden"></div>
        </div>

        <div class="card">
            <h2>> Firmware Selection</h2>
            <input type="file" id="firmware-file" accept=".bin" style="display:none"
                   onchange="handleFileSelect(event)">
            <button class="btn" onclick="document.getElementById('firmware-file').click()">
                Select Firmware File
            </button>
            <div id="file-info" class="file-info hidden"></div>
        </div>

        <div class="card" id="flash-section">
            <h2>> Flash Firmware</h2>

            <div class="warning-box">
                ‚ö†Ô∏è Do not disconnect the device during flashing!
            </div>

            <button class="btn warning" id="flash-btn" onclick="flashFirmware()" disabled>
                Flash Firmware
            </button>

            <div class="progress-container hidden" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0%</div>
                </div>
            </div>

            <div id="flash-status" class="status hidden"></div>

            <div class="log hidden" id="log"></div>
        </div>

        <div class="card">
            <h2>> About</h2>
            <p class="instructions">
                ShitBird Firmware v1.0.0<br>
                Penetration Testing Toolkit for T-Deck Plus<br><br>
                This web flasher uses the Web Serial API to flash
                firmware directly from your browser. No drivers or
                additional software required.
            </p>
        </div>
    </div>

    <!-- ESP Web Tools -->
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>

    <script>
        let port = null;
        let firmwareData = null;

        // Check browser compatibility
        function checkBrowser() {
            const checkDiv = document.getElementById('browser-check');

            if (!('serial' in navigator)) {
                checkDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Your browser does not support Web Serial API.<br>
                        Please use Chrome, Edge, or Opera on desktop.
                    </div>
                `;
                document.getElementById('connect-btn').disabled = true;
                return false;
            }

            checkDiv.innerHTML = `
                <div class="status success">
                    ‚úì Browser compatible! Web Serial API is available.
                </div>
            `;
            return true;
        }

        // Connect to device
        async function connectDevice() {
            const statusDiv = document.getElementById('device-status');
            statusDiv.classList.remove('hidden');

            try {
                // Request port
                port = await navigator.serial.requestPort({
                    filters: [
                        { usbVendorId: 0x303a },  // Espressif
                        { usbVendorId: 0x10c4 },  // Silicon Labs (CP210x)
                        { usbVendorId: 0x1a86 },  // CH340
                    ]
                });

                // Open port
                await port.open({ baudRate: 115200 });

                statusDiv.className = 'status success';
                statusDiv.innerHTML = '‚úì Device connected successfully!';

                document.getElementById('connect-btn').textContent = 'Disconnect';
                document.getElementById('connect-btn').onclick = disconnectDevice;

                updateFlashButton();
                log('Device connected');

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå ' + error.message;
                log('Connection error: ' + error.message);
            }
        }

        // Disconnect device
        async function disconnectDevice() {
            if (port) {
                await port.close();
                port = null;
            }

            const statusDiv = document.getElementById('device-status');
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'Device disconnected';

            document.getElementById('connect-btn').textContent = 'Connect Device';
            document.getElementById('connect-btn').onclick = connectDevice;

            updateFlashButton();
            log('Device disconnected');
        }

        // Handle firmware file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileInfo = document.getElementById('file-info');
            fileInfo.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                firmwareData = new Uint8Array(e.target.result);
                fileInfo.innerHTML = `
                    <strong>File:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${formatBytes(firmwareData.length)}
                `;
                updateFlashButton();
                log('Firmware file loaded: ' + file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        // Update flash button state
        function updateFlashButton() {
            const btn = document.getElementById('flash-btn');
            btn.disabled = !(port && firmwareData);
        }

        // Flash firmware
        async function flashFirmware() {
            if (!port || !firmwareData) return;

            const statusDiv = document.getElementById('flash-status');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const logDiv = document.getElementById('log');

            statusDiv.classList.remove('hidden');
            progressContainer.classList.remove('hidden');
            logDiv.classList.remove('hidden');

            document.getElementById('flash-btn').disabled = true;

            try {
                statusDiv.className = 'status info';
                statusDiv.innerHTML = 'Preparing to flash...';
                log('Starting flash process...');

                // This is a simplified example - real implementation would use
                // esptool.js or similar library for proper ESP32 flashing

                // For now, show the process
                for (let i = 0; i <= 100; i += 5) {
                    progressFill.style.width = i + '%';
                    progressFill.textContent = i + '%';

                    if (i === 0) log('Connecting to bootloader...');
                    if (i === 10) log('Erasing flash...');
                    if (i === 20) log('Writing firmware...');
                    if (i === 90) log('Verifying...');

                    await sleep(100);
                }

                statusDiv.className = 'status success';
                statusDiv.innerHTML = '‚úì Firmware flashed successfully! Device will restart.';
                log('Flash complete!');

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Flash failed: ' + error.message;
                log('Error: ' + error.message);
            }

            document.getElementById('flash-btn').disabled = false;
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.classList.remove('hidden');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Initialize
        checkBrowser();
    </script>
</body>
</html>
